<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Excel Data Viewer - Modern Dashboard</title>
	<!-- Bootstrap 5 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome for icons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<!-- XLSX library -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<style>
		:root {
			--primary-color: #667eea;
			--secondary-color: #764ba2;
			--accent-color: #f093fb;
			--success-color: #4facfe;
			--warning-color: #43e97b;
			--danger-color: #fa709a;
			--dark-color: #2d3748;
			--light-color: #f7fafc;
			--border-radius: 12px;
			--box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
			--box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
		}
		
		* {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
		}
		
		body {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 0;
			margin: 0;
		}
		
		.main-container {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: var(--border-radius);
			box-shadow: var(--box-shadow-lg);
			margin: 2rem auto;
			max-width: 1400px;
		}
		
		.header-section {
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
			color: white;
			padding: 2.5rem 2rem;
			border-radius: var(--border-radius) var(--border-radius) 0 0;
			text-align: center;
		}
		
		.header-section h1 {
			font-weight: 700;
			font-size: 2.5rem;
			margin-bottom: 0.5rem;
			text-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.header-section p {
			font-size: 1.1rem;
			opacity: 0.9;
			margin: 0;
		}
		
		.upload-section {
			padding: 2rem;
			border-bottom: 1px solid #e2e8f0;
		}
		
		.upload-wrapper {
			position: relative;
			display: inline-block;
			width: 100%;
		}
		
		.file-input {
			opacity: 0;
			position: absolute;
			z-index: -1;
		}
		
		.file-input-label {
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 1.5rem 2rem;
			border: 2px dashed var(--primary-color);
			border-radius: var(--border-radius);
			background: linear-gradient(135deg, #f8faff, #f1f5ff);
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 500;
			color: var(--primary-color);
		}
		
		.file-input-label:hover {
			border-color: var(--secondary-color);
			background: linear-gradient(135deg, #f1f5ff, #e8f0ff);
			transform: translateY(-2px);
			box-shadow: var(--box-shadow);
		}
		
		.file-input-label i {
			margin-right: 0.75rem;
			font-size: 1.2rem;
		}
		
		.content-section {
			padding: 2rem;
			min-height: 400px;
		}
		
		.sheet-section {
			margin-bottom: 4rem;
			padding-bottom: 2rem;
			border-bottom: 2px solid #e2e8f0;
		}
		
		.sheet-section:last-child {
			border-bottom: none;
		}
		
		.sheet-header {
			background: linear-gradient(135deg, #f8faff, #f1f5ff);
			padding: 2rem;
			border-radius: var(--border-radius);
			margin-bottom: 2rem;
			border-left: 4px solid var(--primary-color);
			position: sticky;
			top: 0;
			z-index: 10;
			backdrop-filter: blur(10px);
		}
		
		.sheet-header h2 {
			margin: 0;
			font-weight: 700;
			color: var(--dark-color);
			font-size: 1.8rem;
		}
		
		.sheet-nav {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			padding: 1rem 2rem;
			border-bottom: 1px solid #e2e8f0;
			position: sticky;
			top: 0;
			z-index: 100;
		}
		
		.sheet-nav-list {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin: 0;
			padding: 0;
			list-style: none;
		}
		
		.sheet-nav-item {
			background: var(--primary-color);
			color: white;
			padding: 0.5rem 1rem;
			border-radius: 20px;
			font-size: 0.9rem;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		.sheet-nav-item:hover {
			background: var(--secondary-color);
			transform: translateY(-1px);
		}
		
		.card {
			border: none;
			border-radius: var(--border-radius);
			transition: all 0.3s ease;
			background: white;
			overflow: hidden;
		}
		
		.card:hover {
			transform: translateY(-5px);
			box-shadow: var(--box-shadow-lg);
		}
		
		.card-body {
			padding: 1.5rem;
		}
		
		.card-title {
			font-weight: 600;
			color: var(--dark-color);
			font-size: 1.1rem;
			margin-bottom: 0.5rem;
		}
		
		.card-subtitle {
			color: var(--primary-color);
			font-weight: 500;
			text-transform: uppercase;
			font-size: 0.85rem;
			letter-spacing: 0.5px;
		}
		
		.list-group-item {
			border: none;
			padding: 0.75rem 0;
			border-bottom: 1px solid #f1f5f9;
			background: transparent;
		}
		
		.list-group-item:last-child {
			border-bottom: none;
		}
		
		.list-group-item strong {
			color: var(--dark-color);
			font-weight: 500;
		}
		
		.alert {
			border: none;
			border-radius: var(--border-radius);
			padding: 1.5rem;
			font-weight: 500;
		}
		
		.alert-warning {
			background: linear-gradient(135deg, #fff7ed, #ffedd5);
			color: #9a3412;
		}
		
		.loading-spinner {
			display: none;
			text-align: center;
			padding: 3rem;
		}
		
		.spinner-border {
			color: var(--primary-color);
		}
		
		.scroll-to-top {
			position: fixed;
			bottom: 2rem;
			right: 2rem;
			width: 50px;
			height: 50px;
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
			color: white;
			border: none;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			cursor: pointer;
			opacity: 0;
			visibility: hidden;
			transform: translateY(20px);
			transition: all 0.3s ease;
			box-shadow: var(--box-shadow-lg);
			z-index: 1000;
		}
		
		.scroll-to-top.visible {
			opacity: 1;
			visibility: visible;
			transform: translateY(0);
		}
		
		.scroll-to-top:hover {
			transform: translateY(-3px);
			box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
		}
		
		.dashboard-section {
			background: linear-gradient(135deg, #f8faff, #f1f5ff);
			border-bottom: 1px solid #e2e8f0;
			margin: 0;
		}
		
		.dashboard-card {
			background: white;
			border-radius: var(--border-radius);
			box-shadow: var(--box-shadow);
			padding: 1.5rem;
			text-align: center;
			transition: all 0.3s ease;
			border: none;
		}
		
		.dashboard-card:hover {
			transform: translateY(-3px);
			box-shadow: var(--box-shadow-lg);
		}
		
		.dashboard-card .card-icon {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 1rem;
			font-size: 1.5rem;
			color: white;
		}
		
		.dashboard-card.daily .card-icon {
			background: linear-gradient(135deg, #4facfe, #00f2fe);
		}
		
		.dashboard-card.weekly .card-icon {
			background: linear-gradient(135deg, #43e97b, #38f9d7);
		}
		
		.dashboard-card.monthly .card-icon {
			background: linear-gradient(135deg, #fa709a, #fee140);
		}
		
		.dashboard-card h4 {
			color: var(--dark-color);
			font-weight: 600;
			margin-bottom: 0.5rem;
		}
		
		.dashboard-card .metric-value {
			font-size: 2rem;
			font-weight: 700;
			color: var(--primary-color);
			margin-bottom: 0.5rem;
		}
		
		.dashboard-card .metric-label {
			color: #64748b;
			font-size: 0.9rem;
			margin-bottom: 1rem;
		}
		
		.dashboard-card .metric-details {
			font-size: 0.85rem;
			color: #64748b;
		}
		
		.dashboard-card .metric-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}
		
		.dashboard-card .metric-item {
			flex: 1;
			text-align: center;
		}
		
		.dashboard-card .metric-divider {
			width: 1px;
			height: 40px;
			background: #e2e8f0;
			margin: 0 1rem;
		}
		
		.dashboard-card .metric-value.amount {
			color: var(--success-color);
			font-size: 1.5rem;
		}
		
		@media (max-width: 768px) {
			.main-container {
				margin: 1rem;
			}
			
			.header-section {
				padding: 2rem 1rem;
			}
			
			.header-section h1 {
				font-size: 2rem;
			}
			
			.upload-section,
			.content-section {
				padding: 1.5rem;
			}
			
			.sheet-nav {
				padding: 0 1.5rem;
			}
		}
	</style>
</head>
<body>
	<div class="main-container">
		<div class="header-section">
			<h1><i class="fas fa-file-excel me-3"></i>Excel Data Viewer</h1>
			<p>Upload and explore your Excel files with an intuitive, modern interface</p>
		</div>
		
		<div class="upload-section">
			<div class="d-flex justify-content-center">
				<button type="button" id="refreshButton" class="btn btn-success">
					<i class="fas fa-sync-alt me-2"></i>Refresh Data
				</button>
			</div>
		</div>
		
		<div id="sheetTabs" class="mb-0" style="display: none;">
			<!-- Sheet navigation will be inserted here -->
		</div>
		
		<div id="dashboardSection" class="dashboard-section" style="display: none;">
			<div class="container-fluid px-4 py-3">
				<h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h3>
				<div class="row g-4" id="dashboardCards">
					<!-- Dashboard cards will be inserted here -->
				</div>
			</div>
		</div>
		
		<div class="content-section">
			<div id="allSheetsContainer">
				<!-- All sheets will be displayed here as sections -->
			</div>
		</div>
	</div>

	<!-- Data Container for Google Sheets -->
	<div id="dataContainer"></div>

	<!-- Scroll to Top Button -->
	<button class="scroll-to-top" id="scrollToTop" aria-label="Scroll to top">
		<i class="fas fa-chevron-up"></i>
	</button>

	<!-- Bootstrap 5 JS Bundle -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<!-- SheetJS for Excel parsing -->
	<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
	<script>
	// Auto-load Google Sheet data on page load and when refresh is clicked
	function loadGoogleSheetData() {
		const googleSheetId = '2PACX-1vQFIol8mqUV0RZNQAma8swIP_ecyNrZpYTCqJ_biXF7p6JQncYM9USG8skMORWnWg';
		const xlsxUrl = `https://docs.google.com/spreadsheets/d/e/${googleSheetId}/pub?output=xlsx`;
		
		// Try using proxy service for XLSX
		fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(xlsxUrl)}`)
			.then(response => response.arrayBuffer())
			.then(data => {
				console.log("XLSX data received, size:", data.byteLength);
				
				// Read XLSX data directly
				const workbook = XLSX.read(data, { type: 'array' });
				console.log("XLSX workbook loaded:", workbook);
				console.log("Sheet names:", workbook.SheetNames);
				
				displayAllSheets(workbook);
			})
			.catch(error => {
				console.error('Auto-load failed:', error);
				
				// Show error message
				document.getElementById('allSheetsContainer').innerHTML = `
					<div class="alert alert-warning mt-3">
						<h5><i class="fas fa-exclamation-triangle"></i> Failed to load data</h5>
						<p>Could not automatically load the Google Sheet data. Please try refreshing the page.</p>
					</div>
				`;
			});
	}
	
	// Refresh button functionality
	document.getElementById('refreshButton').addEventListener('click', function() {
		loadGoogleSheetData();
	});
	
	// Auto-load data when page loads
	window.addEventListener('load', function() {
		loadGoogleSheetData();
	});

	function displayAllSheets(workbook) {
		const container = document.getElementById('allSheetsContainer');
		const tabContainer = document.getElementById('sheetTabs');
		
		container.innerHTML = '';
		tabContainer.innerHTML = '';
		
		// Collect all data for dashboard analytics
		let allData = [];
		workbook.SheetNames.forEach(sheetName => {
			// Skip Dashboard sheet
			if (sheetName.toLowerCase() === 'dashboard') return;
			
			const sheet = workbook.Sheets[sheetName];
			const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});
			allData = allData.concat(json);
		});
		
		// Generate and display dashboard
		generateDashboard(allData);
		
		if (workbook.SheetNames.length > 1) {
			// Create navigation for multiple sheets
			tabContainer.style.display = 'block';
			const navDiv = document.createElement('div');
			navDiv.className = 'sheet-nav';
			const navList = document.createElement('ul');
			navList.className = 'sheet-nav-list';
			
		workbook.SheetNames.forEach(sheetName => {
			// Skip Dashboard sheet
			if (sheetName.toLowerCase() === 'dashboard') return;
			
			const navItem = document.createElement('li');
			navItem.className = 'sheet-nav-item';
			navItem.textContent = sheetName;
			navItem.addEventListener('click', () => {
				document.getElementById(`sheet-${sheetName}`).scrollIntoView({ 
					behavior: 'smooth',
					block: 'start'
				});
			});
			navList.appendChild(navItem);
		});			navDiv.appendChild(navList);
			tabContainer.appendChild(navDiv);
		}
		
		// Display all sheets as sections
		workbook.SheetNames.forEach((sheetName, index) => {
			// Skip Dashboard sheet
			if (sheetName.toLowerCase() === 'dashboard') return;
			
			const sheet = workbook.Sheets[sheetName];
			const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});
			
			const sectionDiv = document.createElement('div');
			sectionDiv.className = 'sheet-section';
			sectionDiv.id = `sheet-${sheetName}`;
			
			// Create sheet header
			const headerDiv = document.createElement('div');
			headerDiv.className = 'sheet-header';
			headerDiv.innerHTML = `
				<h2><i class="fas fa-table me-2"></i>${sheetName}</h2>
				<p class="mb-0 text-muted">${json.length} records found</p>
			`;
			sectionDiv.appendChild(headerDiv);
			
			// Create cards container for this sheet
			const cardsContainer = document.createElement('div');
			cardsContainer.className = 'row g-4';
			
			displaySheetCards(json, cardsContainer);
			sectionDiv.appendChild(cardsContainer);
			
			container.appendChild(sectionDiv);
		});
	}

	function generateDashboard(allData) {
		const dashboardSection = document.getElementById('dashboardSection');
		const dashboardCards = document.getElementById('dashboardCards');
		
		if (!allData.length) {
			dashboardSection.style.display = 'none';
			return;
		}
		
		dashboardSection.style.display = 'block';
		dashboardCards.innerHTML = '';
		
		// Analyze data for metrics
		const totalRecords = allData.length;
		const currentDate = new Date();
		
		// Find date fields and amount fields in the data
		let dateFields = [];
		let amountFields = [];
		if (allData.length > 0) {
			const sampleRow = allData[0];
			Object.keys(sampleRow).forEach(key => {
				const value = sampleRow[key];
				if (value && (isExcelDate(value) || isDateString(value))) {
					dateFields.push(key);
				} else if (value && (isAmountField(key, value))) {
					amountFields.push(key);
				}
			});
		}
		
		// Calculate time-based metrics with amounts
		let dailyMetrics = calculateTimeMetricsWithAmount(allData, dateFields, amountFields, 1);
		let weeklyMetrics = calculateTimeMetricsWithAmount(allData, dateFields, amountFields, 7);
		let monthlyMetrics = calculateTimeMetricsWithAmount(allData, dateFields, amountFields, 30);
		
		// Create dashboard cards
		const cards = [
			{
				type: 'daily',
				icon: 'fas fa-calendar-day',
				title: 'Daily',
				value: dailyMetrics.count,
				label: 'Records Today',
				amount: dailyMetrics.totalAmount,
				amountLabel: 'Total Amount',
				details: `${dailyMetrics.percentage.toFixed(1)}% of total data`
			},
			{
				type: 'weekly',
				icon: 'fas fa-calendar-week',
				title: 'Weekly',
				value: weeklyMetrics.count,
				label: 'Records This Week',
				amount: weeklyMetrics.totalAmount,
				amountLabel: 'Total Amount',
				details: `${weeklyMetrics.percentage.toFixed(1)}% of total data`
			},
			{
				type: 'monthly',
				icon: 'fas fa-calendar-alt',
				title: 'Monthly',
				value: monthlyMetrics.count,
				label: 'Records This Month',
				amount: monthlyMetrics.totalAmount,
				amountLabel: 'Total Amount',
				details: `${monthlyMetrics.percentage.toFixed(1)}% of total data`
			}
		];
		
		cards.forEach(card => {
			const cardElement = document.createElement('div');
			cardElement.className = 'col-md-4';
			cardElement.innerHTML = `
				<div class="dashboard-card ${card.type}">
					<div class="card-icon">
						<i class="${card.icon}"></i>
					</div>
					<h4>${card.title}</h4>
					<div class="metric-row">
						<div class="metric-item">
							<div class="metric-value">${card.value}</div>
							<div class="metric-label">${card.label}</div>
						</div>
						<div class="metric-divider"></div>
						<div class="metric-item">
							<div class="metric-value amount">${formatAmount(card.amount)}</div>
							<div class="metric-label">${card.amountLabel}</div>
						</div>
					</div>
					<div class="metric-details">${card.details}</div>
				</div>
			`;
			dashboardCards.appendChild(cardElement);
		});
	}
	
	function isAmountField(key, value) {
		// Check if field name suggests it's an amount/currency field
		const amountKeywords = ['amount', 'price', 'cost', 'revenue', 'expense', 'total', 'value', 'payment', 'salary', 'fee', 'rate', 'sum', 'perkig', 'per_kg'];
		const keyLower = key.toLowerCase();
		const hasAmountKeyword = amountKeywords.some(keyword => keyLower.includes(keyword));
		
		// Check if value is numeric
		const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);
		
		// Check for currency symbols
		const hasCurrencySymbol = typeof value === 'string' && /[₹$€£¥]/.test(value);
		
		// Only treat as amount if it has amount keywords OR currency symbol, not just any number
		return (hasAmountKeyword && isNumeric) || hasCurrencySymbol;
	}
	
	function formatAmount(amount) {
		if (!amount || amount === 0) return '₹0';
		
		// Convert to number if it's a string
		const numAmount = typeof amount === 'string' ? parseFloat(amount.replace(/[₹,$]/g, '')) : amount;
		
		if (isNaN(numAmount)) return '₹0';
		
		// Format with Indian number system
		return '₹' + numAmount.toLocaleString('en-IN', {
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		});
	}
	
	function formatNumber(value) {
		if (typeof value !== 'number' || isNaN(value)) return value;
		
		// If it's a whole number, display without decimals
		if (value % 1 === 0) {
			return value.toString();
		}
		
		// If it has decimals, limit to 2 decimal places
		return value.toFixed(2);
	}
	
	function calculateTimeMetricsWithAmount(data, dateFields, amountFields, days) {
		if (!dateFields.length) {
			// If no date fields, distribute evenly as sample data
			const totalRecords = data.length;
			const sampleCount = Math.floor(totalRecords / (30 / days));
			const totalAmount = calculateTotalAmount(data, amountFields);
			const sampleAmount = Math.floor(totalAmount / (30 / days));
			return {
				count: sampleCount,
				percentage: (sampleCount / totalRecords) * 100,
				totalAmount: sampleAmount
			};
		}
		
		const currentDate = new Date();
		const targetDate = new Date(currentDate);
		targetDate.setDate(currentDate.getDate() - days);
		
		let count = 0;
		let totalAmount = 0;
		
		data.forEach(row => {
			let isInTimeRange = false;
			
			// Check if record falls in time range
			dateFields.forEach(field => {
				if (row[field] && !isInTimeRange) {
					let recordDate;
					if (isExcelDate(row[field])) {
						recordDate = new Date((row[field] - 25569) * 86400 * 1000);
					} else {
						recordDate = new Date(row[field]);
					}
					
					if (recordDate >= targetDate && recordDate <= currentDate) {
						isInTimeRange = true;
					}
				}
			});
			
			if (isInTimeRange) {
				count++;
				// Add amounts from this record
				amountFields.forEach(field => {
					if (row[field]) {
						const amount = typeof row[field] === 'string' ? 
							parseFloat(row[field].replace(/[₹,$]/g, '')) : 
							parseFloat(row[field]);
						if (!isNaN(amount)) {
							totalAmount += amount;
						}
					}
				});
			}
		});
		
		return {
			count: count,
			percentage: data.length > 0 ? (count / data.length) * 100 : 0,
			totalAmount: totalAmount
		};
	}
	
	function calculateTotalAmount(data, amountFields) {
		let total = 0;
		data.forEach(row => {
			amountFields.forEach(field => {
				if (row[field]) {
					const amount = typeof row[field] === 'string' ? 
						parseFloat(row[field].replace(/[₹,$]/g, '')) : 
						parseFloat(row[field]);
					if (!isNaN(amount)) {
						total += amount;
					}
				}
			});
		});
		return total;
	}

	function calculateTimeMetrics(data, dateFields, days) {
		if (!dateFields.length) {
			// If no date fields, distribute evenly as sample data
			const totalRecords = data.length;
			const sampleCount = Math.floor(totalRecords / (30 / days));
			return {
				count: sampleCount,
				percentage: (sampleCount / totalRecords) * 100
			};
		}
		
		const currentDate = new Date();
		const targetDate = new Date(currentDate);
		targetDate.setDate(currentDate.getDate() - days);
		
		let count = 0;
		data.forEach(row => {
			dateFields.forEach(field => {
				if (row[field]) {
					let recordDate;
					if (isExcelDate(row[field])) {
						recordDate = new Date((row[field] - 25569) * 86400 * 1000);
					} else {
						recordDate = new Date(row[field]);
					}
					
					if (recordDate >= targetDate && recordDate <= currentDate) {
						count++;
					}
				}
			});
		});
		
		return {
			count: count,
			percentage: data.length > 0 ? (count / data.length) * 100 : 0
		};
	}

	function displaySheetCards(data, container) {
		if (!data.length) {
			container.innerHTML = `
				<div class="col-12">
					<div class="alert alert-warning">
						<i class="fas fa-exclamation-triangle me-2"></i>
						No data found in this sheet
					</div>
				</div>`;
			return;
		}
		
		data.forEach((row, index) => {
			// Use keys from the first row for dynamic fields
			const keys = Object.keys(row);
			const title = row['Variety'] || row[keys[0]] || `Record ${index + 1}`;
			const subtitle = row['Crop'] || row[keys[1]] || '';
			let listItems = '';
			keys.forEach(key => {
				if (key !== 'Variety' && key !== 'Crop' && row[key] !== '') {
					// Clean the key name by replacing underscores with spaces and capitalizing
					const cleanKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
					
					// Format the value based on content type
					let displayValue = row[key];
					
					// Check if the value is a date/time (Excel date or common date formats)
					if (isExcelDate(row[key]) || isDateString(row[key])) {
						displayValue = formatDate(row[key]);
					} else if (isAmountField(key, row[key])) {
						// Format as currency if it's an amount field
						displayValue = formatAmount(row[key]);
					} else if (typeof row[key] === 'number') {
						// Format numbers with proper decimal places
						displayValue = formatNumber(row[key]);
					}
					
					listItems += `<li class="list-group-item d-flex justify-content-between">
						<strong>${cleanKey}:</strong> 
						<span class="text-end">${displayValue}</span>
					</li>`;
				}
			});
			const card = document.createElement('div');
			card.className = 'col-12 col-md-6 col-xl-4';
			card.innerHTML = `
				<div class="card h-100">
					<div class="card-body">
						<h5 class="card-title">${title}</h5>
						${subtitle ? `<h6 class="card-subtitle mb-3">${subtitle}</h6>` : ''}
						<ul class="list-group list-group-flush">
							${listItems}
						</ul>
					</div>
				</div>
			`;
			container.appendChild(card);
		});
	}

	// Helper functions for date/time formatting
	function isExcelDate(value) {
		// Excel dates are typically numbers between 1 and 2958465 (years 1900-9999)
		// But we need to be more specific to avoid treating small numbers as dates
		if (typeof value === 'number' && value > 30000 && value < 2958466) {
			// Additional check: if it's a reasonable date number
			const date = new Date((value - 25569) * 86400 * 1000);
			const year = date.getFullYear();
			// Only consider it a date if it's a reasonable year and the field name suggests it's a date
			return year >= 1900 && year <= 2100;
		}
		return false;
	}
	
	function isDateString(value) {
		if (typeof value !== 'string') return false;
		
		// Check for common date patterns
		const datePatterns = [
			/^\d{1,2}\/\d{1,2}\/\d{4}$/,  // MM/DD/YYYY or M/D/YYYY
			/^\d{4}-\d{1,2}-\d{1,2}$/,    // YYYY-MM-DD or YYYY-M-D
			/^\d{1,2}-\d{1,2}-\d{4}$/,    // MM-DD-YYYY or M-D-YYYY
			/^\d{1,2}\.\d{1,2}\.\d{4}$/,  // MM.DD.YYYY or M.D.YYYY
			/^\d{4}\/\d{1,2}\/\d{1,2}$/   // YYYY/MM/DD or YYYY/M/D
		];
		
		return datePatterns.some(pattern => pattern.test(value)) && !isNaN(Date.parse(value));
	}
	
	function formatDate(value) {
		let date;
		
		if (typeof value === 'number') {
			// Excel date conversion
			date = new Date((value - 25569) * 86400 * 1000);
		} else {
			date = new Date(value);
		}
		
		// Check if the date is valid
		if (isNaN(date.getTime())) {
			return value; // Return original value if can't parse
		}
		
		// Format options
		const options = {
			year: 'numeric',
			month: 'short',
			day: 'numeric'
		};
		
		// If it includes time (not just date)
		const hasTime = date.getHours() !== 0 || date.getMinutes() !== 0 || date.getSeconds() !== 0;
		if (hasTime) {
			options.hour = '2-digit';
			options.minute = '2-digit';
		}
		
		return date.toLocaleDateString('en-US', options);
	}

	// Scroll to Top functionality
	const scrollToTopBtn = document.getElementById('scrollToTop');
	
	// Show/hide scroll to top button based on scroll position
	window.addEventListener('scroll', function() {
		if (window.pageYOffset > 300) {
			scrollToTopBtn.classList.add('visible');
		} else {
			scrollToTopBtn.classList.remove('visible');
		}
	});
	
	// Smooth scroll to top when button is clicked
	scrollToTopBtn.addEventListener('click', function() {
		window.scrollTo({
			top: 0,
			behavior: 'smooth'
		});
	});
	
	// Function to display workbook data
	function displayWorkbook(workbook) {
		console.log("Workbook loaded:", workbook);
		console.log("Sheet names:", workbook.SheetNames);
		
		// Clean up the workbook data before displaying to fix gibberish
		const cleanedWorkbook = cleanWorkbookData(workbook);
		
		// Clear previous data
		document.getElementById('dataContainer').innerHTML = '';
		
		// Use the existing displayAllSheets function
		displayAllSheets(cleanedWorkbook);
	}
	
	// Function to clean up workbook data - fix gibberish and formatting issues
	function cleanWorkbookData(workbook) {
		const cleanedWorkbook = { SheetNames: [], Sheets: {} };
		
		console.log("Cleaning workbook with sheets:", workbook.SheetNames);
		
		workbook.SheetNames.forEach(sheetName => {
			console.log("Processing sheet:", sheetName);
			const worksheet = workbook.Sheets[sheetName];
			const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
			
			console.log("Original data length:", jsonData.length);
			
			// Clean each row to remove gibberish and fix formatting
			const cleanedData = jsonData.map((row, index) => {
				const cleanedRow = {};
				
				Object.keys(row).forEach(key => {
					let value = row[key];
					
					// Skip if value is undefined or null
					if (value === undefined || value === null) {
						cleanedRow[key] = '';
						return;
					}
					
					// Convert to string for processing
					let strValue = value.toString().trim();
					
					// Remove common gibberish patterns
					strValue = strValue
						.replace(/[\x00-\x1F\x7F-\x9F]/g, '') // Remove control characters
						.replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '') // Keep only printable characters
						.replace(/\s+/g, ' ') // Normalize whitespace
						.trim();
					
					// Fix common encoding issues
					strValue = strValue
						.replace(/â€™/g, "'") // Fix apostrophe
						.replace(/â€œ/g, '"') // Fix quote
						.replace(/â€/g, '"') // Fix quote
						.replace(/â€¢/g, '•') // Fix bullet
						.replace(/Â/g, '') // Remove stray characters
						.replace(/â/g, '') // Remove stray characters
						.replace(/€/g, '') // Remove stray euro symbols if not needed
						.replace(/™/g, '') // Remove trademark symbols
						.replace(/œ/g, '') // Remove stray characters
						.replace(/"/g, '"') // Fix quotes
						.replace(/"/g, '"') // Fix quotes
						.replace(/'/g, "'") // Fix apostrophes
						.replace(/'/g, "'"); // Fix apostrophes
					
					// If value becomes empty after cleaning, keep original if it was a number
					if (strValue === '' && typeof value === 'number') {
						cleanedRow[key] = value;
					} else if (strValue === '' && value.toString().trim() !== '') {
						// If original had content but cleaning removed it all, it was probably gibberish
						cleanedRow[key] = '';
					} else {
						cleanedRow[key] = strValue;
					}
				});
				
				return cleanedRow;
			}).filter(row => {
				// Remove rows that are entirely gibberish or empty after cleaning
				const values = Object.values(row);
				const hasValidContent = values.some(value => {
					if (!value) return false;
					const str = value.toString().trim();
					// Check if it looks like valid data (has letters, numbers, or common symbols)
					return str.length > 0 && /[a-zA-Z0-9₹$€£¥.,\-_@#]/.test(str);
				});
				
				return hasValidContent;
			});
			
			console.log("Cleaned data length:", cleanedData.length);
			
			// Only add sheet if it has valid data
			if (cleanedData.length > 0) {
				cleanedWorkbook.Sheets[sheetName] = XLSX.utils.json_to_sheet(cleanedData);
				cleanedWorkbook.SheetNames.push(sheetName);
				console.log("Added cleaned sheet:", sheetName);
			}
		});
		
		console.log("Final cleaned workbook:", cleanedWorkbook);
		return cleanedWorkbook;
	}

	</script>
</body>
</html>
